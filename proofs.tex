\section{Proofs}
\label{sec:proofs}

\begin{figure}
\begin{center}
\fpage{.3}{
$\gamev{G^{\mathrm{pred}}_{XD}}{\advP}$\\
$st \getsr \mdalg(\epsilon,\bot)$\\
$n \getsr \advP^{\mathcal{O}}$\\
Return $[n \in N]$\\

\medskip
\procedurev{$\mathcal{O}(x)$}\\
$(n, st) \getsr \mdalg(st, x)$\\
$N \gets N \cup \{n\}$\\
}
\caption{Unpredictability security game.}
\label{fig:preddef}
\end{center}
\end{figure}

\subsection{Hash-then-encrypt}

\begin{theorem}
Let $\Pi=(\Kgen,\mathsf{enc},\mathsf{dec})$ be a (possibly) randomized public-key encryption scheme, $\pkaead$ be the hash-then-encrypt scheme, and $\mdalg$ be a secret nonce generator.  Then, for any adversary $\advA$, there exist adversaries $\advB1,\advB2,\advP$ (explicitly constructed in the proof of this theorem) such that
\bne
\AdvINDCDA{\kreg,\mdalg,\pkaead}{\advA} \leq 3\AdvINDCPA{\Pi}{\advB} + 2q_h\AdvPred{XD}{\advP}
\ene
When $\advA$ makes $q_e$ queries to its encryption oracle and $q_h$ queries to its random oracle, $\advB1$ and $\advB2$ make $q_e$ queries each to their 
encryption oracles and $q_e + q_h$ queries to their random oracles, and $\advP$ makes $q_e$ queries to the prediction oracle and $q_e + q_h$ queries to the random oracle. 
\end{theorem}

\begin{figure}[tbhp]
\begin{center}
\hfpagesss{.3}{.3}{.3}{
 {$\gamev{G1,\fbox{G0}}{\advA}$}\\
 $(\pk,\sk)\getsr\Kgen$\\
 $b \getsr \bits$ \\
 $st \getsr \mdalg(\epsilon,\bot)$\\
 $b' \getsr \advA^{\encOracle,H}(\pk)$\\
Return $[b=b']$\\ 

\medskip
\procedurev{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  if $T[x] \neq \bot:$\\
  \nudge BAD $= \true$\\
  \nudge \fbox{$Z = T[x]$}\\
  $T[x] = Z$\\
  Return $Z$\\

\medskip
\procedurev{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(st, T) \getsr \mdalg(st,\vmsg_b)$\\
$R \getsr H(\langle \pk,\vad,\vmsg_b,\umd\rangle)$\\
Return $\encprim{\pk}{}{\langle \vmsg_b,\umd\rangle; R}$\\
}
{
$\gamev{G2}{\advA}$\\
 $(\pk,\sk)\getsr\Kgen$\\
 $b \getsr \bits$ \\
 $st \getsr XD(\epsilon,\bot)$\\
 $b' \getsr \advA^{\encOracle,H}(\pk)$\\
 If $\calX \cap \calQ \neq \emptyset$ then \\
\nudge $\bad\gets\true$\\
Return $[b=b']$\\ 

\medskip
\procedurev{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  $\calX \gets \calX \cup \{x\}$\\
  Return $Z$\\

\medskip
\procedurev{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(st, T) \getsr \mdalg(st,\vmsg_b)$\\
$\calQ \gets \calQ \cup \{\langle \pk,\vad,\vmsg_b,\umd\rangle\}$\\
$R \getsr \mathrm{Coins}$\\
Return $\encprim{\pk}{}{\langle \vmsg_b,\umd\rangle; R}$\\
}
{
$\gamev{G3}{\advA}$\\
 $(\pk,\sk)\getsr\Kgen$\\
 $b \getsr \bits$ \\
 $st \getsr \mdalg(\epsilon,\bot)$\\
 $b' \getsr \advA^{\encOracle,H}(\pk)$\\
 If $\calX \cap \calQ \neq \emptyset$ then \\
\nudge $\bad\gets\true$\\
Return $[b=b']$\\ 

\medskip
\procedurev{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  $\calX \gets \calX \cup \{x\}$\\
  Return $Z$\\

\medskip
\procedurev{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(st, T) \getsr \mdalg(st,\vmsg_b)$\\
$\calQ \gets \calQ \cup \{\langle \pk,\vad,\vmsg_b,\umd\rangle\}$\\
$R \getsr \mathrm{Coins}$\\
Return $\encprim{\pk}{}{\langle \vmsg_b,0^{|\umd|}\rangle; R}$\\
}
\caption{Games}
\label{fig:HtEgames}
\end{center}
\end{figure}

\begin{figure}[tbhp]
\begin{center}
\hfpagesss{.3}{.3}{.3}
{
 {$\adversaryv{\;\advB1^{\mathcal{O}}(\pk)}$}\\
$st \getsr \mdalg(\epsilon,\bot)$\\
$d' \getsr \advA^{\encOracle,H}(\pk)$\\
Return $[d=d']'$\\ 

\queryl{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  Return $Z$\\

\queryl{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(\st_0, \umd_0) \getsr \mdalg(st_0,\vmsg_0)$\\
$(\st_1, \umd_1) \getsr \mdalg(st_1,\vmsg_1)$\\
Return $\mathcal{O}(\langle \vmsg_0,\umd_0\rangle, \langle \vmsg_1,\umd_1\rangle)$\\
}
{
{$\adversaryv{\;\advB2^{\mathcal{O}}(\pk)}$}\\
$st \getsr \mdalg(\epsilon,\bot)$\\
$d \getsr \bits$\\ 
$d' \getsr \advA^{\encOracle,H}(\pk)$\\
Return $\bad$\\ 

\queryl{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  $\calX \gets \calX \cup \{x\}$\\
  Return $Z$\\

\queryl{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(\st, \umd) \getsr \mdalg(st,\vmsg)$\\
$\calQ \gets \calQ \cup \{\langle \pk,\vad,\vmsg_b,\umd\rangle\}$\\
Return $\mathcal{O}(\langle \vmsg_d,\umd\rangle, \langle \vmsg_d,0^{|\umd|}\rangle)$\\
}
{
$\gamev{G4}{\advA}$\\
 $(\pk,\sk)\getsr\Kgen$\\
$ b \getsr \bits$\\
 $st \getsr \mdalg(\epsilon,\bot)$\\
 $b' \getsr \advA^{\encOracle,H}(\pk)$\\
 If $\calX \cap \calQ \neq \emptyset$ then \\
\nudge $\bad\gets\true$

\medskip
\procedurev{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  $\calX \gets \calX \cup \{x\}$\\
  Return $Z$\\

\medskip
\procedurev{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(st, T) \getsr \mdalg(st,\vmsg_b)$\\
$\calQ \gets \calQ \cup \{\langle \pk,\vad,\vmsg_b,\umd\rangle\}$\\
$R \getsr \mathrm{Coins}$\\
Return $\encprim{\pk}{}{\langle \vmsg_b, 0^{|\umd|}\rangle; R}$\\
}
\if{0}
{
$\gamev{G4}{\advA}$\\
 $(\pk,\sk)\getsr\Kgen$\\
$ b \getsr \bits$\\
 $st \getsr \mdalg(\epsilon,\bot)$\\
 $b' \getsr \advA^{\encOracle,H}(\pk)$\\
 If $\calX \cap \calQ \neq \emptyset$ then \\
\nudge $ x \getsr \calX$\\
\nudge if $x \in \calQ$ then $\bad\gets\true$

\medskip
\procedurev{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  $\calX \gets \calX \cup \{x\}$\\
  Return $Z$\\

\medskip
\procedurev{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(st, T) \getsr \mdalg(st,\vmsg_b)$\\
$\calQ \gets \calQ \cup \{\langle \pk,\vad,\vmsg_b,\umd\rangle\}$\\
$R \getsr \mathrm{Coins}$\\
Return $\encprim{\pk}{}{\langle \vmsg_b, 0^{|\umd|}\rangle; R}$\\
}
\fi
\caption{Adversary running against the IND-CPA experiment }
\label{fig:CPA-adv}
\end{center}
\end{figure}

\begin{figure}
\begin{center}
\fpage{.3}{
 $\adversaryv{\advP^{\mathcal{O}}}$\\
 $(\pk,\sk) \getsr \Kgen$\\
 $b \getsr \bits$\\
 $b' \getsr \advA^{\encOracle,H}(\pk)$\\
 $\langle \pk,\vad,\vmsg,T \rangle \getsr \cal X$\\
Return $T$\\ 

\queryl{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  $\calX = \calX \cup \{x\}$ \\
  Return $Z$\\

\queryl{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$R \getsr \mathrm{Coins}$\\
Return $\encprim{\pk}{}{\langle \vmsg_b,0^{\ell}\rangle;R}$\\
}
\caption{Need that $|\umd|$ is a function of $||\vmsg||$ only so that $\ell$ is computable.}
\end{center}
\end{figure}
\begin{proof}
We show a series of games to simulate $\ExpINDCDA{U,XD,pkAEAD}{\advA}$ in Figure~\ref{fig:HtEgames}.  In $G0$, matching $\ExpINDCDA{U,XD,pkAEAD}{\advA}$,
the set $Coins$ is defined by the set of all possible random coins used in $\Pi$.  We prevent $\advA$ from sending the same
query to $Enc(\cdot,\cdot,\cdot)$ twice by assuming that one component of $\vad$ is used as a nonce that does not repeat.  Given this
restriction, $BAD$ will only be set if $\advA$ queries the random oracle on a value that was previously submitted to the encryption
oracle.  $G1$ is identical to $G0$ except calls to $H(x)$ always return fresh randomness.
As long as $BAD$ remains false, the randomness in $G0$ and $G1$ is identical, and $G1$ can be simulated by an adversary $\advB1$ 
as shown in Figure~\ref{fig:CPA-adv}.  $G2$ is identical to $G1$ except that instead of maintaining the dictionary $T[x]$, the game maintains
a set containing queries to $H(x)$ by $\advA$ and a set containing queries to $H(x)$ by $\encOracle(\vad,\vmsg_0,\vmsg_1)$.  Note the probability
of $BAD$ is the same in $G1$ and $G2$.  Finally, $G3$ is identical to $G2$ except that the encrypted $T$ is substituted for the zero string $0^{|\umd|}$.
Note that any adversary $\advA$ distinguishing between these two experiments implies and adversary $\advB2$ constructed as in Figure~\ref{fig:CPA-adv}
that can win $\ExpINDCPA{\Pi}{\advB2}$ with the same advantage.  Given $G3$, we construct a prediction adversary $\advP$ in Figure~\ref{fig:CPA-adv}
running in the prediction game $\ExpPred{XD}{\advP}$ as defined in Figure~\ref{fig:preddef} that has a $\frac{1}{q_h}$ probability of guessing which query
from $\advA$ caused $BAD$ to be set.  Thus, we arrive at the following bound:

\bea
Pr[\ExpINDCDA{U,XD,pkAEAD}{\advA} = 1]  = &Pr[G0(\advA) = 1]\\
\leq &Pr[G1(\advA) \wedge \neg BAD] + Pr[G1(\advA) : BAD]\\
\leq &Pr[\ExpINDCPA{\Pi}{\advB1} = 1] + Pr[G1(\advA) : BAD]\\
\leq &Pr[\ExpINDCPA{\Pi}{\advB1} = 1] + Pr[G2(\advA) : BAD]\\
   &-Pr[G2(\advA) : BAD] +  Pr[G2(\advA) : BAD]\\
\leq &Pr[\ExpINDCPA{\Pi}{\advB1} = 1] + \AdvINDCPA{\Pi}{\advB2} +  Pr[G2(\advA) : BAD]\\
\leq &Pr[\ExpINDCPA{\Pi}{\advB1} = 1] + \AdvINDCPA{\Pi}{\advB2} +  q_h\AdvPred{XD}{\advP}\\
\AdvINDCDA{\kreg,\mdalg,\pkaead}{\advA} \leq &\AdvINDCPA{\Pi}{\advB1} + 2\AdvINDCPA{\Pi}{\advB2} +  2q_h\AdvPred{XD}{\advP}
\eea

Where the first inequality is due to the fundamental theorem of games, the second to the existence of $\advB1$, the third and fourth to the existence of $\advB2$,
and the last to the existence of $\advP$.
\end{proof}

\subsection{Hash-then-KEM-DEM}

%GAMES
\begin{figure}[tbhp]
\begin{center}
\hfpagesss{.3}{.3}{.3}{
 {$\gamev{G1,\fbox{G0}}{\advA}$}\\
 $(\pk,\sk)\getsr\Kgen$\\
 $b \getsr \bits$ \\
 $st \getsr \mdalg(\epsilon,\bot)$\\
 $b' \getsr \advA^{\encOracle,H}(\pk)$\\
Return $[b=b']$\\ 

\medskip
\procedurev{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  if $T[x] \neq \bot:$\\
  \nudge BAD $= \true$\\
  \nudge \fbox{$Z = T[x]$}\\
  $T[x] = Z$\\
  Return $Z$\\

\medskip
\procedurev{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(st, T) \getsr \mdalg(st,\vmsg_b)$\\
$R \getsr H(\langle \pk,\vad,\vmsg_b,\umd\rangle)$\\
$(K,X) \gets \encapprim{\pk}{}{R}$\\
$\vad' \gets (\vad, X)$\\
$C \gets \encprim{K}{\vad'}{\langle \vmsg, T\rangle}$\\
Return $(X,C)$\\
}
{
$\gamev{G2}{\advA}$\\
 $(\pk,\sk)\getsr\Kgen$\\
 $b \getsr \bits$ \\
 $st \getsr XD(\epsilon,\bot)$\\
 $b' \getsr \advA^{\encOracle,H}(\pk)$\\
 If $\calX \cap \calQ \neq \emptyset$ then \\
\nudge $\bad\gets\true$\\
Return $[b=b']$\\ 

\medskip
\procedurev{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  $\calX \gets \calX \cup \{x\}$\\
  Return $Z$\\

\medskip
\procedurev{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(st, T) \getsr \mdalg(st,\vmsg_b)$\\
$\calQ \gets \calQ \cup \{\langle \pk,\vad,\vmsg_b,\umd\rangle\}$\\
$R \getsr \mathrm{Coins}$\\
$(K,X) \gets \encapprim{\pk}{}{R}$\\
$\vad' \gets (\vad, X)$\\
$C \gets \encprim{K}{\vad'}{\langle \vmsg, T\rangle}$\\
Return $(X,C)$\\
}
{
$\gamev{G3}{\advA}$\\
 $(\pk,\sk)\getsr\Kgen$\\
 $b \getsr \bits$ \\
 $st \getsr \mdalg(\epsilon,\bot)$\\
 $b' \getsr \advA^{\encOracle,H}(\pk)$\\
 If $\calX \cap \calQ \neq \emptyset$ then \\
\nudge $\bad\gets\true$\\
Return $[b=b']$\\ 

\medskip
\procedurev{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  $\calX \gets \calX \cup \{x\}$\\
  Return $Z$\\

\medskip
\procedurev{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(st, T) \getsr \mdalg(st,\vmsg_b)$\\
$\calQ \gets \calQ \cup \{\langle \pk,\vad,\vmsg_b,\umd\rangle\}$\\
$R \getsr \mathrm{Coins}$\\
$(K,X) \gets \encapprim{\pk}{}{R}$\\
$\vad' \gets (\vad, X)$\\
$C \gets \encprim{K}{\vad'}{\langle \vmsg, 0^{|\umd|}\rangle}$\\
Return $(X,C)$\\
}
\caption{KEM-DEM Games}
\label{fig:CPA-KEMDEM}
\end{center}
\end{figure}

%ADVERSARIES
\begin{figure}[tbhp]
\begin{center}
\hfpagesss{.3}{.3}{.3}
{
 {$\adversaryv{\;\advB1^{\mathcal{O}_\encap}(\pk)}$}\\
$st \getsr \mdalg(\epsilon,\bot)$\\
$d \getsr \bits$\\
$d' \getsr \advA^{\encOracle,H}(\pk)$\\
Return $[d=d']$\\ 

\queryl{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  Return $Z$\\

\queryl{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(\st, \umd) \getsr \mdalg(st,\vmsg_d)$\\
$(K,X) \gets \mathcal{O}_\encap()$\\
$\vad' \gets (\vad, X)$\\
$C \gets \encprim{K}{\vad'}{\langle \vmsg, T\rangle}$\\
Return $(X,C)$\\
}
{
{$\adversaryv{\;\advB1^{\mathcal{O}_\enc}()}$}\\
$st \getsr \mdalg(\epsilon,\bot)$\\
$(\pk,\sk)\getsr\Kgen$\\
$d' \getsr \advA^{\encOracle,H}(\pk)$\\
Return $d'$\\ 

\queryl{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  Return $Z$\\

\queryl{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(\st_0, \umd_0) \getsr \mdalg(st_0,\vmsg_0)$\\
$(\st_1, \umd_1) \getsr \mdalg(st_1,\vmsg_1)$\\
$R \getsr \mathrm{Coins}$\\
$(K',X') \gets \encapprim{\pk}{}{R}$\\
$\vad' \gets (\vad, X')$\\
$C \gets \mathcal{O}_\enc(\vad',\langle \vmsg_0,\umd_0\rangle, \langle \vmsg_1,\umd_1\rangle)$\\
Return $(X',C)$\\
}
{
{$\adversaryv{\;\advB2^{\mathcal{O}}(\pk)}$}\\
$st \getsr \mdalg(\epsilon,\bot)$\\
$d \getsr \bits$\\ 
$d' \getsr \advA^{\encOracle,H}(\pk)$\\
Return $\bad$\\ 

\queryl{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  $\calX \gets \calX \cup \{x\}$\\
  Return $Z$\\

\queryl{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$(\st, \umd) \getsr \mdalg(st,\vmsg)$\\
$\calQ \gets \calQ \cup \{\langle \pk,\vad,\vmsg_d,\umd\rangle\}$\\
$R \getsr \mathrm{Coins}$\\
$(K',X') \gets \encapprim{\pk}{}{R}$\\
$\vad' \gets (\vad, X')$\\
$C \gets \mathcal{O}_\enc(\vad',\langle \vmsg_d,\umd\rangle, \langle \vmsg_d,0^{|\umd|}\rangle)$\\
Return $(X',C)$\\
}
\caption{Adversary running against the IND-CPA experiment.}
\label{fig:CPA-KDadv}
\end{center}
\end{figure}

\begin{figure}
\begin{center}
\fpage{.3}{
 $\adversaryv{\advP^{\mathcal{O}}}$\\
 $(\pk,\sk) \getsr \Kgen$\\
 $b \getsr \bits$\\
 $b' \getsr \advA^{\encOracle,H}(\pk)$\\
 $\langle \pk,\vad,\vmsg,T \rangle \getsr \cal X$\\
Return $T$\\ 

\queryl{$H(x)$}\\
  $Z \getsr \mathrm{Coins}$\\
  $\calX = \calX \cup \{x\}$ \\
  Return $Z$\\

\queryl{$\encOracle(\vad,\vmsg_0,\vmsg_1)$}\\
$R \getsr \mathrm{Coins}$\\
$(K,X) \gets \encapprim{\pk}{}{R}$\\
$\vad' \gets (\vad, X)$\\
$C \gets \encprim{K}{\vad'}{\langle \vmsg_b, 0^{\ell}\rangle}$\\
Return $(X,C)$\\
}
\caption{Need that $|\umd|$ is a function of $||\vmsg||$ only so that $\ell$ is computable.}
\end{center}
\end{figure}

%Sample code---------------
%\begin{figure}[t]
%\noindent{$\mathcal{B}(PK)$}
%\begin{algorithmic}[1]
%\STATE $St = \emptyset$ 
%\STATE $PK = c \leftarrow e(X,Y)$
%\STATE $C = \emptyset$
%\STATE $V = \emptyset$
%\STATE $\text{run }\mathcal{A}(PK)$
%\end{algorithmic}
%
%\noindent{\bf On query} $Enc(A,M_0,M_1)$
%\begin{algorithmic}[1]
%\STATE $St', T_0 \leftarrow XD(St, M_0)$
%\STATE $St, T_1 \leftarrow XD(St, M_1)$
%\STATE $M'_0 = M_0||T_0$
%\STATE $M'_1 = M_1||T_1$
%%\IF {$M'_0||M'_1 \notin C$}
%\STATE{$C_b \leftarrow LR(M_0,T_0;M_1,T_1)$}
%\STATE $C = C \cup (M'_0,M'_1,C_b)$
%%\ELSE
%\STATE $C(M'_0||M'_1)$
%\RETURN $C_b$
%\end{algorithmic}
%
%\noindent{\bf On query} $H(x)$
%\begin{algorithmic}[1]
%\RETURN $H(x)$
%\end{algorithmic}
%\caption{Adversary}
%\label{fig:}
%\end{figure}